name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      build_target:
        description: 'Which project to build'
        required: true
        type: choice
        options:
          - backend
          - frontend
          - both
        default: 'both'
      backend_version:
        description: 'Backend version (leave empty to use .version.json)'
        required: false
        type: string
        default: ''
      frontend_version:
        description: 'Frontend version (leave empty to use .version.json)'
        required: false
        type: string
        default: ''
      platforms:
        description: 'Which platforms to build'
        required: true
        type: choice
        options:
          - linux-amd64
          - darwin-arm64
          - both
        default: 'both'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Read version from .version.json (runs for all events)
  read-versions:
    runs-on: ubuntu-latest
    name: Read Versions
    outputs:
      backend_version: ${{ steps.read.outputs.backend_version }}
      frontend_version: ${{ steps.read.outputs.frontend_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read versions
        id: read
        run: |
          # Read current versions from .version.json
          BACKEND_VERSION=$(grep '"backend"' .version.json | sed -E 's/.*"backend"[[:space:]]*:[[:space:]]*"([^"]+)".*/\1/')
          FRONTEND_VERSION=$(grep '"frontend"' .version.json | sed -E 's/.*"frontend"[[:space:]]*:[[:space:]]*"([^"]+)".*/\1/')
          
          echo "backend_version=$BACKEND_VERSION" >> $GITHUB_OUTPUT
          echo "frontend_version=$FRONTEND_VERSION" >> $GITHUB_OUTPUT

  # Pre-build checks (only on main branch auto push and PR)
  lint-and-check:
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    name: Lint, Version & Security Checks
    outputs:
      backend-changed: ${{ steps.detect.outputs.backend }}
      frontend-changed: ${{ steps.detect.outputs.frontend }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: detect
        run: |
          # Check if backend files changed
          if git diff --name-only HEAD~1 | grep -q "^backend/"; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi

          # Check if frontend files changed
          if git diff --name-only HEAD~1 | grep -q "^frontend/"; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run frontend linter
        working-directory: ./frontend
        run: npm run lint
        continue-on-error: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: "backend/requirements.txt"

      - name: Install backend dependencies
        working-directory: ./backend
        run: pip install -r requirements.txt

      - name: Run backend linter (pylint)
        working-directory: ./backend
        run: |
          pip install pylint
          pylint app/ --exit-zero --disable=all --enable=E,F
        continue-on-error: true

      - name: Check version format in .version.json
        run: |
          if [ ! -f ".version.json" ]; then
            echo "Error: .version.json is missing"
            exit 1
          fi

          BACKEND_VERSION=$(grep '"backend"' .version.json | sed -E 's/.*"backend"[[:space:]]*:[[:space:]]*"([^"]+)".*/\1/')
          FRONTEND_VERSION=$(grep '"frontend"' .version.json | sed -E 's/.*"frontend"[[:space:]]*:[[:space:]]*"([^"]+)".*/\1/')

          for VERSION in "$BACKEND_VERSION" "$FRONTEND_VERSION"; do
            if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "Error: Version must be semantic (e.g., 0.1.0), got: $VERSION"
              exit 1
            fi
          done

      - name: Scan for PII (email, phone, API keys)
        run: |
          if grep -r -E 'sk_[a-zA-Z0-9]{20,}|pk_[a-zA-Z0-9]{20,}|ghp_[a-zA-Z0-9]{20,}' \
            . --include="*.py" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=__pycache__; then
            echo "Error: Found potential API keys in source code"
            exit 1
          fi

  # Determine what to build (auto or manual)
  determine-build:
    runs-on: ubuntu-latest
    name: Determine Build Targets
    outputs:
      build-backend: ${{ steps.decide.outputs.backend }}
      build-frontend: ${{ steps.decide.outputs.frontend }}
      build-linux-amd64: ${{ steps.decide.outputs.build_linux_amd64 }}
      build-darwin-arm64: ${{ steps.decide.outputs.build_darwin_arm64 }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine build targets
        id: decide
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - use workflow inputs directly
            BUILD_TARGET="${{ inputs.build_target }}"
            BUILD_PLATFORMS="${{ inputs.platforms }}"
          else
            # Auto trigger - detect changes directly here
            if git diff --name-only HEAD~1 | grep -q "^backend/"; then
              BACKEND_CHANGED=true
            else
              BACKEND_CHANGED=false
            fi

            if git diff --name-only HEAD~1 | grep -q "^frontend/"; then
              FRONTEND_CHANGED=true
            else
              FRONTEND_CHANGED=false
            fi
            

            # Convert to build target format
            if [ "$BACKEND_CHANGED" == "true" ] && [ "$FRONTEND_CHANGED" == "true" ]; then
              BUILD_TARGET="both"
            elif [ "$BACKEND_CHANGED" == "true" ]; then
              BUILD_TARGET="backend"
            elif [ "$FRONTEND_CHANGED" == "true" ]; then
              BUILD_TARGET="frontend"
            else
              BUILD_TARGET="none"
            fi

            # For push/PR, always build both platforms
            BUILD_PLATFORMS="both"
          fi
          
          # Determine which platforms to build
          if [ "$BUILD_PLATFORMS" == "linux-amd64" ]; then
            BUILD_LINUX_AMD64=true
            BUILD_DARWIN_ARM64=false
          elif [ "$BUILD_PLATFORMS" == "darwin-arm64" ]; then
            BUILD_LINUX_AMD64=false
            BUILD_DARWIN_ARM64=true
          else
            BUILD_LINUX_AMD64=true
            BUILD_DARWIN_ARM64=true
          fi
          
          # Set backend and frontend build flags based on build target
          if [ "$BUILD_TARGET" == "backend" ] || [ "$BUILD_TARGET" == "both" ]; then
            BUILD_BACKEND=true
          else
            BUILD_BACKEND=false
          fi
          
          if [ "$BUILD_TARGET" == "frontend" ] || [ "$BUILD_TARGET" == "both" ]; then
            BUILD_FRONTEND=true
          else
            BUILD_FRONTEND=false
          fi
          
          echo "backend=$BUILD_BACKEND" >> $GITHUB_OUTPUT
          echo "frontend=$BUILD_FRONTEND" >> $GITHUB_OUTPUT
          echo "build_linux_amd64=$BUILD_LINUX_AMD64" >> $GITHUB_OUTPUT
          echo "build_darwin_arm64=$BUILD_DARWIN_ARM64" >> $GITHUB_OUTPUT
          
          echo "Build config:"
          echo "  Target: $BUILD_TARGET (backend: $BUILD_BACKEND, frontend: $BUILD_FRONTEND)"
          echo "  Platforms: linux-amd64=$BUILD_LINUX_AMD64, darwin-arm64=$BUILD_DARWIN_ARM64"

  # Build and push backend image (linux/amd64)
  build-backend-linux-amd64:
    if: |
      needs.determine-build.outputs.build-backend == 'true' &&
      needs.determine-build.outputs.build-linux-amd64 == 'true'
    needs: [determine-build, read-versions]
    runs-on: ubuntu-latest
    name: Build Backend (linux/amd64)
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read backend version
        id: version
        run: |
          # Use provided version or read from .version.json
          if [ -n "${{ inputs.backend_version }}" ]; then
            CURRENT_VERSION="${{ inputs.backend_version }}"
          elif [ "${{ needs.read-versions.outputs.backend_version }}" != '' ]; then
            CURRENT_VERSION="${{ needs.read-versions.outputs.backend_version }}"
          else
            CURRENT_VERSION=$(grep '"backend"' .version.json | sed -E 's/.*"backend"[[:space:]]*:[[:space:]]*"([^"]+)".*/\1/')
          fi
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Building backend version: $CURRENT_VERSION for platform: linux/amd64"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:backend-${{ steps.version.outputs.new }}-amd64
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:backend-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Build and push backend image (darwin/arm64)
  build-backend-darwin-arm64:
    if: |
      needs.determine-build.outputs.build-backend == 'true' &&
      needs.determine-build.outputs.build-darwin-arm64 == 'true'
    needs: [determine-build, read-versions]
    runs-on: ubuntu-latest
    name: Build Backend (darwin/arm64)
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Read backend version
        id: version
        run: |
          # Use provided version or read from .version.json
          if [ -n "${{ inputs.backend_version }}" ]; then
            CURRENT_VERSION="${{ inputs.backend_version }}"
          elif [ "${{ needs.read-versions.outputs.backend_version }}" != '' ]; then
            CURRENT_VERSION="${{ needs.read-versions.outputs.backend_version }}"
          else
            CURRENT_VERSION=$(grep '"backend"' .version.json | sed -E 's/.*"backend"[[:space:]]*:[[:space:]]*"([^"]+)".*/\1/')
          fi
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Building backend version: $CURRENT_VERSION for platform: darwin/arm64"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:backend-${{ steps.version.outputs.new }}-arm64
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:backend-latest-arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Build and push frontend image (linux/amd64)
  build-frontend-linux-amd64:
    if: |
      needs.determine-build.outputs.build-frontend == 'true' &&
      needs.determine-build.outputs.build-linux-amd64 == 'true'
    needs: [determine-build, read-versions]
    runs-on: ubuntu-latest
    name: Build Frontend (linux/amd64)
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read frontend version
        id: version
        run: |
          # Use provided version or read from .version.json
          if [ -n "${{ inputs.frontend_version }}" ]; then
            CURRENT_VERSION="${{ inputs.frontend_version }}"
          elif [ "${{ needs.read-versions.outputs.frontend_version }}" != '' ]; then
            CURRENT_VERSION="${{ needs.read-versions.outputs.frontend_version }}"
          else
            CURRENT_VERSION=$(grep '"frontend"' .version.json | sed -E 's/.*"frontend"[[:space:]]*:[[:space:]]*"([^"]+)".*/\1/')
          fi
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Building frontend version: $CURRENT_VERSION for platform: linux/amd64"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:frontend-${{ steps.version.outputs.new }}-amd64
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:frontend-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Build and push frontend image (darwin/arm64)
  build-frontend-darwin-arm64:
    if: |
      needs.determine-build.outputs.build-frontend == 'true' &&
      needs.determine-build.outputs.build-darwin-arm64 == 'true'
    needs: [determine-build, read-versions]
    runs-on: ubuntu-latest
    name: Build Frontend (darwin/arm64)
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Read frontend version
        id: version
        run: |
          # Use provided version or read from .version.json
          if [ -n "${{ inputs.frontend_version }}" ]; then
            CURRENT_VERSION="${{ inputs.frontend_version }}"
          elif [ "${{ needs.read-versions.outputs.frontend_version }}" != '' ]; then
            CURRENT_VERSION="${{ needs.read-versions.outputs.frontend_version }}"
          else
            CURRENT_VERSION=$(grep '"frontend"' .version.json | sed -E 's/.*"frontend"[[:space:]]*:[[:space:]]*"([^"]+)".*/\1/')
          fi
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Building frontend version: $CURRENT_VERSION for platform: darwin/arm64"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:frontend-${{ steps.version.outputs.new }}-arm64
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:frontend-latest-arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Create release (only on push to main)
  create-release:
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' &&
      (needs.build-backend-linux-amd64.result == 'success' || needs.build-frontend-linux-amd64.result == 'success')
    needs: [build-backend-linux-amd64, build-frontend-linux-amd64]
    runs-on: ubuntu-latest
    name: Create GitHub Release
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read versions
        id: versions
        run: |
          BACKEND_VERSION=$(grep '"backend"' .version.json | sed -E 's/.*"backend"[[:space:]]*:[[:space:]]*"([^"]+)".*/\1/')
          FRONTEND_VERSION=$(grep '"frontend"' .version.json | sed -E 's/.*"frontend"[[:space:]]*:[[:space:]]*"([^"]+)".*/\1/')
          echo "backend=$BACKEND_VERSION" >> $GITHUB_OUTPUT
          echo "frontend=$FRONTEND_VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: release-${{ github.run_number }}
          release_name: Release ${{ steps.versions.outputs.backend }}-${{ steps.versions.outputs.frontend }}
          body: |
            ## Docker Images
            
            ### Backend
            - Linux AMD64: `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:backend-${{ steps.versions.outputs.backend }}-amd64`
            - Linux ARM64: `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:backend-${{ steps.versions.outputs.backend }}-arm64`
            
            ### Frontend
            - Linux AMD64: `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:frontend-${{ steps.versions.outputs.frontend }}-amd64`
            - Linux ARM64: `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:frontend-${{ steps.versions.outputs.frontend }}-arm64`

            ## Latest Tags
            - Backend Latest (AMD64): `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:backend-latest`
            - Frontend Latest (AMD64): `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:frontend-latest`
          draft: false
          prerelease: false

  # Test images (only on push to main)
  test-images:
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' && 
      (needs.build-backend-linux-amd64.result == 'success' || needs.build-frontend-linux-amd64.result == 'success')
    needs: [build-backend-linux-amd64, build-frontend-linux-amd64]
    runs-on: ubuntu-latest
    name: Test Built Images
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read versions
        id: versions
        run: |
          BACKEND_VERSION=$(grep '"backend"' .version.json | sed -E 's/.*"backend"[[:space:]]*:[[:space:]]*"([^"]+)".*/\1/')
          FRONTEND_VERSION=$(grep '"frontend"' .version.json | sed -E 's/.*"frontend"[[:space:]]*:[[:space:]]*"([^"]+)".*/\1/')
          echo "backend=$BACKEND_VERSION" >> $GITHUB_OUTPUT
          echo "frontend=$FRONTEND_VERSION" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Test backend image
        if: needs.build-backend-linux-amd64.result == 'success'
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:backend-${{ steps.versions.outputs.backend }}-amd64
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:backend-${{ steps.versions.outputs.backend }}-amd64 python -c "import fastapi; print('✓ FastAPI available')"

      - name: Test frontend image
        if: needs.build-frontend-linux-amd64.result == 'success'
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:frontend-${{ steps.versions.outputs.frontend }}-amd64
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:frontend-${{ steps.versions.outputs.frontend }}-amd64 npm --version > /dev/null && echo "✓ Frontend verified"
