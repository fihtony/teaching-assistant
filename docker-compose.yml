version: "3.8"

services:
  # Init service to create data folders if they don't exist
  init:
    image: busybox:latest
    container_name: teaching-assistant-init
    command: sh -c "mkdir -p /app/data /app/logs && echo 'Folders initialized'"
    networks:
      - teaching-network

  backend:
    image: ghcr.io/${REGISTRY_OWNER:-fihtony}/teaching-assistant:backend-${BACKEND_VERSION:-latest}-amd64
    container_name: teaching-assistant-backend
    platform: linux/amd64
    depends_on:
      init:
        condition: service_completed_successfully
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - DATA_DIR=/app/data
      - LOGS_DIR=/app/logs
    volumes:
      - ${DATA_PATH:-./data}:/app/data
      - ${LOGS_PATH:-./logs}:/app/logs
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import requests; requests.get('http://localhost:8090/api/v1/greeting', timeout=5)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - teaching-network
    restart: unless-stopped
    user: "2000:2000"

  frontend:
    image: ghcr.io/${REGISTRY_OWNER:-fihtony}/teaching-assistant:frontend-${FRONTEND_VERSION:-latest}-amd64
    container_name: teaching-assistant-frontend
    platform: linux/amd64
    ports:
      - "${FRONTEND_PORT:-9011}:3090"
    environment:
      - REACT_APP_API_URL=http://backend:8090
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:3090/",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - teaching-network
    restart: unless-stopped
    user: "2000:2000"

networks:
  teaching-network:
    driver: bridge

# Docker Compose Override Files
# For different platforms, create docker-compose.{platform}.override.yml:
#
# Example for Apple Silicon (macOS):
#   docker-compose.darwin-arm64.override.yml:
#     services:
#       backend:
#         image: ghcr.io/fihtony/teaching-assistant:backend-${BACKEND_VERSION:-latest}-darwin-arm64
#         platform: linux/arm64
#       frontend:
#         image: ghcr.io/fihtony/teaching-assistant:frontend-${FRONTEND_VERSION:-latest}-darwin-arm64
#         platform: linux/arm64
#
# Example for ARM64 Linux:
#   docker-compose.arm64.override.yml:
#     services:
#       backend:
#         image: ghcr.io/fihtony/teaching-assistant:backend-${BACKEND_VERSION:-latest}-arm64
#         platform: linux/arm64
#       frontend:
#         image: ghcr.io/fihtony/teaching-assistant:frontend-${FRONTEND_VERSION:-latest}-arm64
#         platform: linux/arm64
